<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Tableau de bord - Technicien</title>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body>
  <div class="dashboard-container">
    <!-- Barre lat√©rale -->
    <nav class="sidebar">
      <ul>
        <li data-target="listeIncidentsTech">Mes Incidents</li>
        <li data-target="profilTech">Profil</li>
        <li data-target="logout">D√©connexion</li>
      </ul>
    </nav>

    <!-- Contenu principal -->
    <div class="main-content">

      <!-- Liste incidents assign√©s au technicien -->
      <section id="listeIncidentsTech">
        <h2>üõ†Ô∏è Mes Incidents Assign√©s</h2>
        <table id="incidentsTableTech" border="1">
          <thead>
            <tr>
              <th>ID</th>
              <th>Num√©ro Ticket</th>
              <th>SN</th>
              <th>Description</th>
              <th>Lieu</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="incidentTableBody"></tbody>

        </table>
      </section>

      <!-- Profil technicien -->
      <section id="profilTech" style="display: none;">
        <h2>üë§ Mon Profil</h2>
        <div class="profile-card">
          <div class="photo-container">
            <img id="profilImageTech" src="images/imglogin.png" alt="Photo de profil">
          </div>
          <div class="profile-details">
            <p><i class="fas fa-user"></i> <strong>Nom :</strong> <span id="profilNomTech">...</span></p>
            <p><i class="fas fa-envelope"></i> <strong>Email :</strong> <span id="profilEmailTech">...</span></p>
          </div>
        </div>
      </section>

    </div>
  </div>

  <script>
    const email = localStorage.getItem("userEmail");
    const role = localStorage.getItem("role");

// ‚úÖ Contr√¥le d'acc√®s pour technicien
if (!email || role !== "technicien") {
  window.location.href = "login.html"; // redirection si non connect√© ou mauvais r√¥le
}

    

    document.addEventListener("DOMContentLoaded", () => {
      loadIncidentsTech();
      loadProfilTech();
    });

    // Charger les incidents du technicien
    async function loadIncidentsTech() {
    const emailTech = localStorage.getItem("userEmail"); // üõ† On r√©cup√®re l'email du technicien connect√©

    try {
        const response = await fetch(`http://localhost:3001/incidents-par-technicien/${emailTech}`); // üõ† On charge les incidents li√©s √† son email
        const incidents = await response.json();

        const tbody = document.querySelector("#incidentsTableTech tbody");
        tbody.innerHTML = "";

        incidents.forEach(incident => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td>${incident.id_incident}</td>
                <td>${incident.numero_ticket}</td>
                <td>${incident.sn}</td>
                <td>${incident.description}</td>
                <td>${incident.lieu}</td>
                <td>${incident.status || "En cours"}</td>
                <td><button onclick="updateStatus(${incident.id_incident})">Changer statut</button></td>
            `;
            tbody.appendChild(tr);
        });
    } catch (err) {
        console.error("Erreur chargement incidents technicien :", err);
    }
}



    
    // Charger le profil technicien
    async function loadProfilTech() {
      const email = localStorage.getItem("userEmail");
      try {
        const res = await fetch(`http://localhost:3001/utilisateur/${email}`);
        const user = await res.json();
        document.getElementById("profilNomTech").textContent = user.nom_utilisateur;
        document.getElementById("profilEmailTech").textContent = user.email_utilisateur;
      } catch (err) {
        console.error("Erreur chargement profil technicien :", err);
      }
    }

    // Fonction pour changer le statut de l‚Äôincident
  // Fonction pour changer le statut de l‚Äôincident (‚ö†Ô∏è envoie toutes les donn√©es !)
async function updateStatus(id) {
  const nouveauStatus = prompt("Entrez le nouveau statut (ex: En cours, Cl√¥tur√©) :");
  if (!nouveauStatus) return;

  try {
    // üîÅ Charger l'incident complet avant modification
    const resIncident = await fetch(`http://localhost:3001/incidents/${id}`);
    const incident = await resIncident.json();

    // ‚úÖ Envoyer tous les champs, avec juste le nouveau status modifi√©
    const updatedData = {
      numero_ticket: incident.numero_ticket,
      sn: incident.sn,
      utilisateur: incident.utilisateur,
      description: incident.description,
      email: incident.email,
      technicien: incident.technicien,
      nature_resolution: incident.nature_resolution || "",
      status: nouveauStatus
    };

    const res = await fetch(`http://localhost:3001/incidents/${id}`, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(updatedData)
    });

    if (res.ok) {
      alert("‚úÖ Statut mis √† jour !");
      loadIncidentsTech();
    } else {
      alert("‚ùå Erreur mise √† jour.");
    }
  } catch (err) {
    console.error("Erreur update status :", err);
    alert("‚ùå Erreur serveur.");
  }
}


    // D√©connexion
    document.querySelector('[data-target="logout"]').addEventListener("click", () => {
      localStorage.clear();
      window.location.href = "login.html";
    });

    // Changer entre sections
    document.querySelectorAll(".sidebar li").forEach(item => {
      item.addEventListener("click", () => {
        const target = item.getAttribute("data-target");

        document.querySelectorAll("section").forEach(section => {
          section.style.display = "none";
        });

        if (target !== "logout") {
          document.getElementById(target).style.display = "block";
        }
      });
    });
  </script>

</body>
</html>
